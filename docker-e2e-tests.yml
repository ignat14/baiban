version: '3.8'

services:
  e2e_web:
    image: baiban_e2e_web
    build:
      context: .
      dockerfile: Dockerfile
    volumes:
      - .:/code
      - ./media:/media
      - ./static:/static
    depends_on:
      - e2e_db
    command: /bin/bash -c "pip install -r requirements_dev.txt; python tasks.py"
    env_file:
      - ./config/env_vars/db/dev_e2e_db.env
    environment:
      - ENV=dev
    tty: true

  e2e_frontend:
    image: baiban_e2e_frontend
    build:
      context: frontend
    volumes:
      - ./frontend:/srv/client
    command: /bin/bash -c "npm i; npm run serve"

  e2e_db:
    image: postgres:13
    env_file:
      - ./config/env_vars/db/dev_e2e_db.env

  e2e_nginx:
    image: nginx:1.17.4
    depends_on:
      - e2e_web
      - e2e_frontend
    volumes:
      - ./config/e2e_nginx.conf:/etc/nginx/conf.d/default.conf
      - ./media:/media:ro
      - ./static:/static:ro
    command:
      /bin/bash -c "nginx -g 'daemon off;'"

  cypress:
    image: cypress/included:3.2.0
    volumes:
      - ./frontend/tests/e2e:/e2e
      - ./scripts:/scripts
    depends_on:
      - e2e_web
      - e2e_frontend
      - e2e_nginx
    environment:
      - CYPRESS_baseUrl=http://e2e_nginx:80
    entrypoint:
      /scripts/wait-for-it.sh e2e_frontend:8080 -- cypress run
    working_dir: '/e2e'

networks:
  default:
    external:
      name: baiban_e2e_tests
